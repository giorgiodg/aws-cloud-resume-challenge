<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.13.10"><title>Notes</title><style>html{background-color:var(--clr-bg);font-family:sans-serif;--clr-bg: #1f2024;--clr-bg-alt: #24272f;--clr-fg: #b6b2ac;--clr-fg-alt: #f4b857;--clr-primary: #c47b06;--shadow: rgba(0, 0, 0, .16) 0px 10px 36px 0px, rgba(0, 0, 0, .06) 0px 0px 0px 1px}body{margin:0 auto;width:100%;max-width:80ch;padding:1rem;line-height:1.5;color:var(--clr-fg)}a{color:var(--clr-fg)}*{box-sizing:border-box}h1,h2,h3,h4,h5{color:var(--clr-primary)}h1{margin:1rem 0;font-size:2.5rem}footer a{padding:.5rem 1rem;background-color:var(--clr-bg-alt);text-decoration:none}.nav-links{width:100%;top:5rem;left:48px;color:var(--clr-primary);display:none;margin:0}.nav-links a{display:block;text-align:center;padding:10px 0;text-decoration:none;font-size:1.2rem;font-weight:700;text-transform:lowercase}.nav-links a:hover,.nav-links a:focus{color:var(--clr-primary)}.expanded{display:unset}@media screen and (min-width: 636px){.nav-links{margin-left:5em;display:block;position:static;width:auto;background:none}.nav-links a{display:inline-block;padding:15px 20px}.hamburger{display:none}}footer[data-astro-cid-sz7xmlte]{display:flex;gap:1rem;margin-top:2rem}
code[class*=language-],pre[class*=language-]{-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;white-space:pre;white-space:pre-wrap;word-wrap:normal;font-family:Menlo,Monaco,Courier New,monospace;font-size:14px;color:#76d9e6;text-shadow:none}pre>code[class*=language-]{font-size:1em}pre[class*=language-],:not(pre)>code[class*=language-]{background:#2a2a2a}pre[class*=language-]{padding:15px;border-radius:4px;border:1px solid #e1e1e8;overflow:auto;position:relative}pre[class*=language-] code{white-space:pre;display:block}:not(pre)>code[class*=language-]{padding:.15em .2em .05em;border-radius:.3em;border:.13em solid #7a6652;box-shadow:1px 1px .3em -.1em #000 inset}.token.namespace{opacity:.7}.token.comment,.token.prolog,.token.doctype,.token.cdata{color:#6f705e}.token.operator,.token.boolean,.token.number{color:#a77afe}.token.attr-name,.token.string,.token.entity,.token.url,.language-css .token.string,.style .token.string{color:#e6d06c}.token.selector,.token.inserted{color:#a6e22d}.token.atrule,.token.attr-value,.token.keyword,.token.important,.token.deleted{color:#ef3b7d}.token.regex,.token.statement{color:#76d9e6}.token.placeholder,.token.variable{color:#fff}.token.important,.token.statement,.token.bold{font-weight:700}.token.punctuation{color:#bebec5}.token.entity{cursor:help}.token.italic{font-style:italic}code.language-markup{color:#f9f9f9}code.language-markup .token.tag{color:#ef3b7d}code.language-markup .token.attr-name{color:#a6e22d}code.language-markup .token.attr-value{color:#e6d06c}code.language-markup .token.style,code.language-markup .token.script,code.language-markup .token.script .token.keyword{color:#76d9e6}.line-highlight.line-highlight{padding:0;background:#ffffff14}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{padding:.2em .5em;background-color:#fff6;color:#000;height:1em;line-height:1em;box-shadow:0 1px 1px #ffffffb3}
</style></head> <body> <header> <nav> <div class="nav-links"> <!-- <a href="/">Home</a> --> </div> </nav> </header>  <main> <h1>Challenges</h1> <h3>1. HTML website</h3> <p>
There's not much to say here. I chose to use <a target="_blank" href="https://astro.build/">Astro</a> since it's a lightweight and fast framework. After having tried more complex
      frameworks like GatsbyJS and Next.js, I felt relieved by its shallow learning
      curve and by how quickly I could launch a working product.
</p> <h3>2. CloudFront and S3</h3> <h4>Create a S3 bucket</h4> <p>
Create a new bucket in your region picking up a unique name. Ensure to
      keep "ACLs disabled" and "Block all public access" enabled, while it's
      your call to leave the Bucket versioning switched on. Disable the "Static
      website hosting" option because CloudFront will take care of content
      delivery. Lastly, I suggest you tag the bucket with the key-value pair
<i>(project,Cloud Resume Challenge)</i>.
</p> <h4>Setup CloudFront</h4> <p>
CloudFront works through distributions, so create a new one picking up a
      name and choosing "Single website or app". Specify Amazon S3 as the origin
      and browse through your S3 buckets to select the one hosting your website.
      Leave the origin path empty unless your index.html is <b>not</b> in the bucket
      root folder.<br>
After having selected "Do not enable security protections" move on and create
      the distribution. It will take some minute to deploy. While the deployment
      takes place you can edit a couple of important settings.<br>
First, modify the root object to "index.html", which will be the default file
      served when accessing the website. Second, go in the "Behavior" tab and change
      the "Viewer protocol policy" to Redirect HTTP to HTTPS to ensure the secure
      transfer of data.
</p> <h4>Fix subfolder access</h4> <p>
If your website is made up of subfolders that turn into URLs like /about/,
      /blog/ etc, you may come across an access denied error. Since we're not
      using the S3 static website endpoint, they will not be identified as valid
      objects. We can solve this by implementing a simple CloudFront function
      that appends index.html where necessary.
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> request <span class="token operator">=</span> event<span class="token punctuation">.</span>request<span class="token punctuation">;</span>
    <span class="token keyword">var</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span>uri<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span>uri <span class="token operator">+=</span> <span class="token string">'index.html'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uri<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span>uri <span class="token operator">+=</span> <span class="token string">'/index.html'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> request<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre> </p> <h3>3. Domain and SSL integration with CloudFront</h3> <p>TBD</p> <h3>4. Setup a view counter through Lambda, DynamoDB and JavaScript</h3> <h4>Setup DynamoDB</h4> <p>
We're now going to create a view counter. Rather than accessing the
      database from our page, we will call a Lambda to fecth the value from
      DynamoDB.<br>
Hover to DynamoDB, create a new table, and specify "id" as the Partition key.
      Tag the object with the usual pair (project,Cloud Resume Challenge). Once it
      shows as active, head to "Explore table items" to create an item with an attribute
      named "views" having a value of 1 and type set as Number.
</p> <h4>Create a Lambda function</h4> <p>
Let's create a Lambda function to interact with our DynamoDB table to read
      and increment the view count.<br>
Head to AWS Lambda and click on "Create function", specify a name and choose
      your favourite runtime. I chose Node.js 22.x because of my former JavaScript
      expertise. Tag the lambda with the usual pair (project,Cloud Resume Challenge).<br>
In the advanced settings, we will also enable the "Function URL" to allow interaction
      with the Lambda through HTTP requests, and set the Auth type as "NONE" to allow
      unrestricted access. We will also need to enable CORS to allowlist our website
      URL as the only allowed origin for calling the API. If you plan to test your
      Lambda from a browser or a CURL, you may <b>temporarily</b> leave that set
      to "*".
</p> <p>
Now it's time to setup the right permissions, since the Lambda will have
      to access to DynamoDB both for reading and writing. Therefore, go to the
      "Permissions" tab within the "Configuration" section and click on the
      hyperlink associated to the "Execution role". Add this IAM role the
      "AmazonDynamoDBFullAccess" policy.
</p> <h4>Create the Lambda JavaScript logic</h4> <p>
We'll need to create a logic to
</p><ol> <li>
Retrieve the current value of the "views" attribute from the table
</li> <li>Increment the retrieved value by 1</li> <li>Update the table with the new "views" value</li> <li>Return the updated value as the output of the Lambda.</li> </ol>
Here's the snippet code you can deploy to fullfill this:
 <pre class="language-js"><code class="language-js">
      <span class="token keyword">import</span> <span class="token punctuation">{</span> DynamoDBClient<span class="token punctuation">,</span> GetItemCommand <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@aws-sdk/client-dynamodb"</span><span class="token punctuation">;</span>
      <span class="token keyword">import</span> <span class="token punctuation">{</span> unmarshall <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@aws-sdk/util-dynamodb"</span><span class="token punctuation">;</span>
      <span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateItemCommand <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@aws-sdk/client-dynamodb'</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamoDBClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">region</span><span class="token operator">:</span> <span class="token string">"&lt;&lt;type your AWS region>>"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token constant">TABLE_NAME</span> <span class="token operator">=</span> <span class="token string">"&lt;&lt;type your DynamoDB table>>"</span><span class="token punctuation">;</span>

      <span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> getCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetItemCommand</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">TableName</span><span class="token operator">:</span> <span class="token constant">TABLE_NAME</span><span class="token punctuation">,</span>
            <span class="token literal-property property">Key</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">S</span><span class="token operator">:</span> <span class="token string">"1"</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> getResponse <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>getCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>getResponse<span class="token punctuation">.</span>Item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">statusCode</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">,</span>
              <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Item not found"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">const</span> updateCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateItemCommand</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">TableName</span><span class="token operator">:</span> <span class="token constant">TABLE_NAME</span><span class="token punctuation">,</span>
            <span class="token literal-property property">Key</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">S</span><span class="token operator">:</span> <span class="token string">"1"</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">UpdateExpression</span><span class="token operator">:</span> <span class="token string">"SET #v = if_not_exists(#v, :start) + :inc"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">ExpressionAttributeNames</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">"#v"</span><span class="token operator">:</span> <span class="token string">"view"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">ExpressionAttributeValues</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">":inc"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">N</span><span class="token operator">:</span> <span class="token string">"1"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token string-property property">":start"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">N</span><span class="token operator">:</span> <span class="token string">"0"</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">ReturnValues</span><span class="token operator">:</span> <span class="token string">"ALL_NEW"</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> updateResponse <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>updateCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> updatedItem <span class="token operator">=</span> <span class="token function">unmarshall</span><span class="token punctuation">(</span>updateResponse<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">statusCode</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
            <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">view</span><span class="token operator">:</span> updatedItem<span class="token punctuation">.</span>view <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error fetching/updating item:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">statusCode</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
            <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">"Internal Server Error"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span> </code></pre> <p>
You can either use a CURL or a browser to invoke the Lambda and check if
      the view counter has been increased.
</p> <h4>Create the website JavaScript logic</h4> <p>
This JavaScript snippet fetches the view count data from the Lambda and
      updates the content of the "#views" HTML element. This is executed once
      the page loads.
</p> <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> views <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#views"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>views<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Element not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
        <span class="token string">"&lt;&lt;type your lambda URL>>"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      views<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Views: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>view<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error updating view counter"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">updateCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>
It's up to you whether you add it as an inline &lt;script&gt; or in a
      standalone .js file that you'll have to reference in your HTML file. Just
      make sure
</p> <p>
Now that you've successfully tested the client-server interaction, it's
      time to go back to the CORS settings of your Lambda. Therefore, replace
      "*" with the Lambda URL to avoid unexpected calls.
</p> <h4>Terraform (iaC)</h4> <p>
This is probably the part which took longer, as I had to learn how to port
      all my past implementations and also surfaced new challenges. On the flip
      side, it allowed me to speed up testing by drastically reducing manual
      toil.
</p> <p>
So far I moved CloudFront and S3 management to Terraform. If you're
      interested in the code you can check my <a href="https://github.com/giorgiodg/aws-cloud-resume-challenge/tree/main/terraform">GitHub repo</a> </p> </main> <footer data-astro-cid-sz7xmlte> <p data-astro-cid-sz7xmlte> <a target="_blank" href="https://www.linkedin.com/in/giorgiodellegrottaglie">linkedin</a> <a target="_blank" href="https://www.github.com/giorgiodg">github</a> </p> <span id="views"></span> <script type="module">const r=document.querySelector("#views");async function t(){if(!r){console.error("Element not found");return}try{let o=await(await fetch("https://m2rremcwou4tyn4pw7g7vehr6i0ohkjj.lambda-url.eu-west-3.on.aws/")).json();r.innerHTML=`Views: ${o.view}`}catch(e){console.error("Error updating view counter",e)}}t();</script> </footer> </body></html>